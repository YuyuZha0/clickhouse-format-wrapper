<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CCS6CPTZW9"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-CCS6CPTZW9');
    </script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="Free online clickhouse sql formatter, support highlighting, compatible with clickhouse-format"/>
    <meta name="keywords" content="clickhouse, sql, formatter, highlight, clickhouse-format"/>
    <title>Online Clickhouse SQL Formatter</title>
    <link rel="icon" type="image/x-icon" href="https://clickhouse.com/docs/img/docs_favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css"
          integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <style>
        :root {
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --dark-gray: #dee2e6;
            --text-color: #212529;
            --primary-color: #007bff;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--light-gray);
            display: flex;
            flex-direction: column;
        }

        .main-container {
            flex: 1 0 auto;
            padding: 1rem 1.5rem;
        }

        .page-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .page-header img {
            width: 32px;
            height: 32px;
        }

        .page-header h3 {
            margin-bottom: 0;
            color: #343a40;
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            background-color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 0.25rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-top: 1rem;
        }

        .dropdown-menu {
            max-height: 400px;
            overflow-y: auto;
        }

        .dropdown-menu form .form-check, .dropdown-menu form .form-group {
            margin-bottom: 0.75rem;
        }

        .dropdown-menu form label {
            font-size: 0.9em;
            margin-bottom: 0.25rem;
        }

        .editor-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }

        .CodeMirror {
            border: 1px solid var(--dark-gray);
            height: 65vh;
            font-size: 0.95em;
            border-radius: 0.25rem;
        }

        #sqlOutput {
            border: 1px solid var(--dark-gray);
            height: 65vh;
            background-color: #fff;
            padding: 10px;
            font-family: Consolas, "Courier New", monospace;
            font-size: 0.95em;
            overflow-y: auto;
            border-radius: 0.25rem;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            /* === CORRECTED STYLES FOR LINE BREAKS === */
            white-space: pre-wrap; /* Preserves newlines and wraps lines that are too long. */
            overflow-wrap: break-word; /* Breaks words only if they would otherwise overflow. */
        }

        #sqlOutput .placeholder-text {
            color: #6c757d;
            margin: auto;
            text-align: center;
        }

        #sqlOutput code {
            display: block;
            white-space: inherit; /* Inherit wrapping rules from parent */
            color: var(--text-color);
        }

        #sqlOutput p.text-danger {
            margin: 0;
            font-weight: bold;
        }

        .footer {
            flex-shrink: 0;
            background-color: var(--medium-gray);
            color: #6c757d;
            font-size: 0.9rem;
        }

        .footer a {
            color: #495057;
            text-decoration: none;
        }

        .footer a:hover {
            color: var(--text-color);
        }

        /* Minor adjustment for mobile */
        @media (max-width: 767.98px) {
            .CodeMirror, #sqlOutput {
                height: 40vh;
            }

            .main-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
<div class="container-fluid main-container">
    <header class="page-header pb-2 mb-2 border-bottom">
        <img src="https://clickhouse.com/docs/img/docs_favicon.ico" alt="ClickHouse logo">
        <h3>Online Clickhouse SQL Formatter</h3>
    </header>

    <!-- Control Panel -->
    <div class="row">
        <div class="col-12">
            <div class="control-panel">
                <button class="btn btn-primary" type="button" id="formatBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Format SQL (Ctrl+Enter)">
                    <i class="fa fa-play" aria-hidden="true"></i> Format
                </button>
                <button class="btn btn-outline-secondary" type="button" id="copyBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Copy to Clipboard">
                    <i class="fa fa-clipboard" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="clearBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Clear Editors">
                    <i class="fa fa-trash" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="undoBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Undo (Ctrl+Z)">
                    <i class="fa fa-undo" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="redoBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Redo (Ctrl+Y)">
                    <i class="fa fa-repeat" aria-hidden="true"></i>
                </button>
                <a href="https://clickhouse.com/docs/en/sql-reference" class="btn btn-outline-secondary" target="_blank"
                   data-toggle="tooltip" data-placement="bottom" title="ClickHouse SQL Reference">
                    <i class="fa fa-book"></i>
                </a>

                <!-- Options Dropdown (pushed to the right) -->
                <div class="dropdown ml-auto">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenu2"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-toggle="tooltip"
                            data-placement="bottom" title="Formatting Options">
                        <i class="fa fa-cog" aria-hidden="true"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu2">
                        <form class="px-3 py-2">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="autoFormatCheck">
                                <label class="form-check-label" for="autoFormatCheck"
                                       title="Enable auto format on text change">Auto Format</label>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="form-check">
                                <input type="checkbox" checked="checked" class="form-check-input" id="hiliteCheck">
                                <label class="form-check-label" for="hiliteCheck"
                                       title="Add syntax highlight with ANSI terminal escape sequences">Highlight
                                    (ANSI)</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" checked="checked" class="form-check-input" id="commentsCheck">
                                <label class="form-check-label" for="commentsCheck"
                                       title="Keep comments in the output">Keep Comments</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="onelineCheck">
                                <label class="form-check-label" for="onelineCheck" title="Format in single line">Single
                                    Line</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="multiqueryCheck">
                                <label class="form-check-label" for="multiqueryCheck"
                                       title="Allow multiple queries in the same file">Allow Multi-query</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="backslashCheck">
                                <label class="form-check-label" for="backslashCheck"
                                       title="Add a backslash at the end of each line">Add Backslashes</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       id="allowSettingsAfterFormatInInsertCheck">
                                <label class="form-check-label"
                                       for="allowSettingsAfterFormatInInsertCheck"
                                       title="Allow SETTINGS after FORMAT (not always safe)">Allow SETTINGS after
                                    FORMAT</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="obfuscateCheck">
                                <label class="form-check-label" for="obfuscateCheck"
                                       title="Obfuscate instead of formatting">Obfuscate</label>
                            </div>

                            <div class="dropdown-divider"></div>
                            <div class="form-group">
                                <label for="maxLineLengthInput"
                                       title="Format in single line queries with length less than specified">Max Line
                                    Length:</label>
                                <input type="number" class="form-control form-control-sm" id="maxLineLengthInput"
                                       placeholder="e.g., 120">
                            </div>
                            <div class="form-group">
                                <label for="seedInput"
                                       title="Seed (arbitrary string) that determines the result of obfuscation">Obfuscation
                                    Seed:</label>
                                <input type="text" class="form-control form-control-sm" id="seedInput">
                            </div>
                            <div class="form-group">
                                <label for="maxQuerySizeInput"
                                       title="The maximum number of bytes of a query string parsed by the SQL parser.">Max
                                    Query Size (bytes):</label>
                                <input type="number" class="form-control form-control-sm" id="maxQuerySizeInput"
                                       placeholder="e.g., 262144">
                            </div>
                            <div class="form-group mb-0">
                                <label for="maxParserDepthInput"
                                       title="Maximum parser depth (recursion depth of recursive descend parser).">Max
                                    Parser Depth:</label>
                                <input type="number" class="form-control form-control-sm" id="maxParserDepthInput"
                                       placeholder="e.g., 1000">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SQL Input/Output Row -->
    <div class="row sql-areas mt-3">
        <div class="col-md-6 mb-3 mb-md-0">
            <label class="editor-label" for="sqlInput">Source SQL</label>
            <textarea id="sqlInput"></textarea>
        </div>
        <div class="col-md-6">
            <label class="editor-label" for="sqlOutput">Formatted Output</label>
            <div id="sqlOutput"></div>
        </div>
    </div>
</div>

<footer class="footer mt-auto py-3 text-center">
    <div class="container">
        <span>Powered by <a href="https://clickhouse.com/docs/en/operations/utilities/clickhouse-format"
                            target="_blank">clickhouse-format</a>.</span>
        <span>View on <a href="https://github.com/ClickHouse/clickhouse-sql-formatter-web" target="_blank"><i
                class="fa fa-github"></i> GitHub</a>.</span>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"
        integrity="sha512-6cPYokihlrofMNApz7OXVQNObWjLiKGIBBb7+UB+AuMiRCLKmFKgrwms21sHq3bdFFZWpfHYRJBJvMFMPj1S9g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
    $(function () {
        // Initialize all tooltips
        $('[data-toggle="tooltip"]').tooltip({container: 'body'});

        // Prevent dropdown from closing when interacting with form elements
        $('.dropdown-menu').on('click', function (e) {
            e.stopPropagation();
        });

        const elements = Object.freeze({
            editor: CodeMirror.fromTextArea(document.getElementById("sqlInput"), {
                lineNumbers: true,
                mode: "text/x-sql",
                matchBrackets: true,
                smartIndent: true,
                indentWithTabs: false,
                tabSize: 4,
                autoCloseBrackets: true,
                styleActiveLine: true,
                lineWrapping: true,
                placeholder: "Paste your ClickHouse SQL here...",
                extraKeys: {
                    "Ctrl-Enter": formatRequest,
                    "Cmd-Enter": formatRequest
                }
            }),
            output: $('#sqlOutput'),
            hilite: $('#hiliteCheck'),
            oneline: $('#onelineCheck'),
            multiquery: $('#multiqueryCheck'),
            backslash: $('#backslashCheck'),
            allowSettingsAfterFormatInInsert: $('#allowSettingsAfterFormatInInsertCheck'),
            obfuscate: $('#obfuscateCheck'),
            comments: $('#commentsCheck'),
            seed: $('#seedInput'),
            maxQuerySize: $('#maxQuerySizeInput'),
            maxParserDepth: $('#maxParserDepthInput'),
            maxLineLength: $('#maxLineLengthInput'),
            autoFormat: $('#autoFormatCheck'),
            formatBtn: $('#formatBtn'),
            clearBtn: $('#clearBtn'),
            undoBtn: $('#undoBtn'),
            redoBtn: $('#redoBtn'),
            copyBtn: $('#copyBtn'),
        });

        const outputPlaceholder = '<div class="placeholder-text">Formatted SQL will appear here</div>';

        const getOptions = function () {
            const obj = {
                hilite: elements.hilite.prop('checked'),
                oneline: elements.oneline.prop('checked'),
                comments: elements.comments.prop('checked'),
                multiquery: elements.multiquery.prop('checked'),
                backslash: elements.backslash.prop('checked'),
                allowSettingsAfterFormatInInsert: elements.allowSettingsAfterFormatInInsert.prop('checked'),
                obfuscate: elements.obfuscate.prop('checked'),
                seed: elements.seed.val(),
                maxQuerySize: elements.maxQuerySize.val(),
                maxParserDepth: elements.maxParserDepth.val(),
                maxLineLength: elements.maxLineLength.val()
            };
            for (let key in obj) {
                const val = obj[key];
                if (!val) { // handles false, '', null, undefined, 0
                    delete obj[key];
                }
            }
            return obj;
        };

        const highlighter = new AnsiUp();

        const isNotBlank = function (str) {
            return str && str.trim().length > 0;
        };

        function formatRequest() {
            const sql = elements.editor.getValue();
            if (!isNotBlank(sql)) {
                return;
            }
            elements.output.html('<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div></div>');
            const options = getOptions();
            $.ajax({
                url: 'api/format?' + $.param(options),
                method: 'POST',
                contentType: "text/plain; charset=utf-8",
                data: sql,
                dataType: 'text'
            }).done(function (data) {
                gtag('event', 'format_success', {'inputLength': sql.length, 'outputLength': data.length});
                if (options.hilite) {
                    elements.output.html(highlighter.ansi_to_html(data));
                } else {
                    // Wrap in code tag for consistent styling and semantic meaning
                    elements.output.html($('<code/>').text(data));
                }
                // Set the text content for clipboard.js
                elements.output.attr('data-clipboard-text', data);
            }).fail(function (xhr, status, error) {
                gtag('event', 'format_error', {'inputLength': sql.length, 'status': status, 'error': error});
                elements.output.html(`<p class="text-danger">${xhr.responseText || 'An unknown error occurred.'}</p>`);
                elements.output.removeAttr('data-clipboard-text');
            });
        }

        let timer = null;
        elements.editor.on('change', function () {
            if (timer) {
                clearTimeout(timer);
            }
            if (elements.autoFormat.prop('checked')) {
                timer = setTimeout(formatRequest, 300);
            }
        });
        elements.formatBtn.on('click', formatRequest);

        // Initialize Clipboard.js and provide user feedback
        const clipboard = new ClipboardJS('#copyBtn', {
            text: function (trigger) {
                // Copy the plain text content, not the HTML
                return $('#sqlOutput').attr('data-clipboard-text') || '';
            }
        });

        clipboard.on('success', function (e) {
            const trigger = $(e.trigger);
            const originalTitle = trigger.attr('data-original-title');
            trigger.attr('data-original-title', 'Copied!').tooltip('show');
            setTimeout(function () {
                trigger.tooltip('hide').attr('data-original-title', originalTitle);
            }, 2000);
            e.clearSelection();
        });

        clipboard.on('error', function (e) {
            const trigger = $(e.trigger);
            const originalTitle = trigger.attr('data-original-title');
            trigger.attr('data-original-title', 'Press Ctrl+C to copy').tooltip('show');
            setTimeout(function () {
                trigger.tooltip('hide').attr('data-original-title', originalTitle);
            }, 2000);
        });


        elements.clearBtn.on('click', function () {
            elements.editor.setValue('');
            elements.output.html(outputPlaceholder).removeAttr('data-clipboard-text');
            elements.editor.focus();
        });

        elements.undoBtn.on('click', () => elements.editor.undo());
        elements.redoBtn.on('click', () => elements.editor.redo());

        // Initial state
        elements.output.html(outputPlaceholder);
    });
</script>
</body>
</html>