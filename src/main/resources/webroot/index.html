<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CCS6CPTZW9"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-CCS6CPTZW9');
    </script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="Free online clickhouse sql formatter, support highlighting, compatible with clickhouse-format"/>
    <meta name="keywords" content="clickhouse, sql, formatter, highlight, clickhouse-format"/>
    <title>Online Clickhouse SQL Formatter</title>
    <link rel="icon" type="image/x-icon" href="https://clickhouse.com/docs/img/docs_favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/material-darker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/eclipse.min.css">
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --heading-color: #343a40;
            --border-color: #dee2e6;
            --control-panel-bg: #ffffff;
            --control-panel-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            --editor-bg: #ffffff;
            --editor-output-bg: #f1f3f5;
            --button-outline-color: #6c757d;
            --button-hover-bg: #e9ecef;
            --tooltip-bg: #343a40;
            --spinner-color: #17a2b8; /* Bootstrap .text-info */
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --heading-color: #f8f9fa;
            --border-color: #444;
            --control-panel-bg: #2c2c2c;
            --control-panel-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            --editor-bg: #2c2c2c; /* Matches CodeMirror material-darker theme */
            --editor-output-bg: #252525;
            --button-outline-color: #adb5bd;
            --button-hover-bg: #495057;
            --tooltip-bg: #f8f9fa;
            --spinner-color: #28a745; /* Bootstrap .text-success for better contrast */
        }

        /* --- General Body & Layout --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            padding-top: 1rem;
        }

        .main-container {
            padding: 0 20px 20px;
        }

        h3 {
            color: var(--heading-color);
            border-bottom: 1px solid var(--border-color);
        }

        hr {
            border-top: 1px solid var(--border-color);
            margin: 1.5rem 0;
        }

        /* --- Control Panel --- */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--control-panel-bg);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem; /* Slightly more rounded */
            box-shadow: var(--control-panel-shadow);
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .control-panel .btn {
            color: var(--button-outline-color);
            border-color: var(--button-outline-color);
        }

        .control-panel .btn:hover, .control-panel .btn:focus {
            background-color: var(--button-hover-bg);
            color: var(--heading-color); /* Use a high-contrast text color on hover */
        }

        /* Group related buttons with a separator */
        .control-separator {
            width: 1px;
            height: 24px;
            background-color: var(--border-color);
            margin: 0 0.25rem;
        }

        /* Push theme toggle to the end */
        .theme-toggle {
            margin-left: auto;
        }

        /* --- Options Dropdown --- */
        .dropdown-menu {
            max-height: 450px;
            overflow-y: auto;
            background-color: var(--control-panel-bg);
            border-color: var(--border-color);
        }

        .dropdown-menu form {
            color: var(--text-color);
        }

        .dropdown-menu form h6 {
            color: #6c757d;
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }

        .dropdown-menu form h6:first-of-type {
            margin-top: 0;
        }

        .dropdown-menu .form-check-label, .dropdown-menu .form-group label {
            font-size: 0.9em;
        }

        .dropdown-divider {
            border-top: 1px solid var(--border-color);
        }

        /* --- SQL Editors (CodeMirror & Output) --- */
        .editor-container {
            position: relative;
        }

        .editor-label {
            position: absolute;
            top: -1.2rem;
            left: 0.5rem;
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }

        .CodeMirror {
            border: 1px solid var(--border-color);
            height: 70vh;
            min-height: 300px;
            font-size: 0.95em;
            border-radius: 0.375rem;
            background-color: var(--editor-bg) !important; /* Override theme styles */
        }

        #sqlOutput {
            border: 1px solid var(--border-color);
            height: 70vh;
            min-height: 300px;
            background-color: var(--editor-output-bg);
            padding: 10px;
            font-family: Consolas, "Courier New", monospace;
            font-size: 0.95em;
            overflow: auto; /* Use 'auto' for better scrollbar behavior */
            border-radius: 0.375rem;
            line-height: 1.5;
            white-space: pre; /* Use 'pre' for performance with ANSI output, relying on ansi_up for line breaks */
        }

        /* Cautious styling for ANSI output: Only set base color.
           ansi_up.js will add its own spans for colors. */
        #sqlOutput code {
            color: var(--text-color);
        }

        /* Error messages */
        #sqlOutput p.text-danger {
            margin: 0;
            font-weight: bold;
            white-space: pre-wrap; /* Allow errors to wrap */
        }

        /* Center spinner vertically */
        #sqlOutput .d-flex {
            height: 100%;
            align-items: center;
        }

        #sqlOutput .spinner-border {
            color: var(--spinner-color);
        }

        /* --- Tooltips --- */
        .tooltip-inner {
            background-color: var(--tooltip-bg);
            color: var(--bg-color); /* Invert text color for contrast */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        .bs-tooltip-auto[x-placement^=bottom] .arrow::before, .bs-tooltip-bottom .arrow::before {
            border-bottom-color: var(--tooltip-bg);
        }

        .bs-tooltip-auto[x-placement^=top] .arrow::before, .bs-tooltip-top .arrow::before {
            border-top-color: var(--tooltip-bg);
        }

        .bs-tooltip-auto[x-placement^=right] .arrow::before, .bs-tooltip-right .arrow::before {
            border-right-color: var(--tooltip-bg);
        }

        .bs-tooltip-auto[x-placement^=left] .arrow::before, .bs-tooltip-left .arrow::before {
            border-left-color: var(--tooltip-bg);
        }

        /* --- Mobile Adjustments --- */
        @media (max-width: 767.98px) {
            .CodeMirror, #sqlOutput {
                height: 45vh;
                min-height: 250px;
            }

            .theme-toggle {
                margin-left: 0;
            }
        }
    </style>
</head>
<body data-theme="light"> <!-- Default theme -->

<div class="container-fluid main-container">
    <h3 class="pb-2 mb-3">Online Clickhouse SQL Formatter</h3>

    <div class="row">
        <div class="col-12">
            <div class="control-panel">
                <button class="btn btn-outline-secondary" type="button" id="formatBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Format SQL (Ctrl+Enter)">
                    <i class="fa fa-play" aria-hidden="true"></i> Format
                </button>
                <button class="btn btn-outline-secondary" type="button" id="copyBtn" data-clipboard-target="#sqlOutput"
                        data-toggle="tooltip" data-placement="bottom" title="Copy to Clipboard">
                    <i class="fa fa-clipboard" aria-hidden="true"></i> Copy
                </button>
                <button class="btn btn-outline-secondary" type="button" id="clearBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Clear Input">
                    <i class="fa fa-trash" aria-hidden="true"></i> Clear
                </button>

                <div class="control-separator"></div>

                <button class="btn btn-outline-secondary" type="button" id="undoBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Undo (Ctrl+Z)">
                    <i class="fa fa-undo" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="redoBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Redo (Ctrl+Y)">
                    <i class="fa fa-repeat" aria-hidden="true"></i>
                </button>

                <div class="control-separator"></div>

                <a href="https://clickhouse.com/docs/en/sql-reference" class="btn btn-outline-secondary" target="_blank"
                   rel="noopener" data-toggle="tooltip" data-placement="bottom" title="ClickHouse SQL Reference">
                    <i class="fa fa-book"></i>
                </a>

                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenu2"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-bars" aria-hidden="true"></i> Options
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu2">
                        <form class="px-3 py-2" onsubmit="return false;">
                            <h6>Formatting</h6>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="autoFormatCheck">
                                <label class="form-check-label" for="autoFormatCheck" data-toggle="tooltip"
                                       data-placement="left" title="Automatically format as you type">Auto
                                    Format</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" checked="checked" class="form-check-input" id="commentsCheck">
                                <label class="form-check-label" for="commentsCheck" data-toggle="tooltip"
                                       data-placement="left" title="Keep comments in the output">Keep Comments</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="onelineCheck">
                                <label class="form-check-label" for="onelineCheck" data-toggle="tooltip"
                                       data-placement="left" title="Format query into a single line">Single Line</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="multiqueryCheck">
                                <label class="form-check-label" for="multiqueryCheck" data-toggle="tooltip"
                                       data-placement="left" title="Allow multiple queries separated by semicolons">Allow
                                    Multi-query</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="backslashCheck">
                                <label class="form-check-label" for="backslashCheck" data-toggle="tooltip"
                                       data-placement="left" title="Add a backslash at the end of each line">Add
                                    Backslashes</label>
                            </div>

                            <h6>Highlighting & Obfuscation</h6>
                            <div class="form-check">
                                <input type="checkbox" checked="checked" class="form-check-input" id="hiliteCheck">
                                <label class="form-check-label" for="hiliteCheck" data-toggle="tooltip"
                                       data-placement="left"
                                       title="Use ANSI terminal escape sequences for syntax highlighting">Highlight
                                    (ANSI)</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="obfuscateCheck">
                                <label class="form-check-label" for="obfuscateCheck" data-toggle="tooltip"
                                       data-placement="left"
                                       title="Obfuscate query instead of formatting">Obfuscate</label>
                            </div>
                            <div class="form-group mb-2">
                                <label for="seedInput" data-toggle="tooltip" data-placement="left"
                                       title="Seed for deterministic obfuscation">Obfuscation Seed:</label>
                                <input type="text" class="form-control form-control-sm" id="seedInput">
                            </div>

                            <h6>Advanced</h6>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       id="allowSettingsAfterFormatInInsertCheck">
                                <label class="form-check-label" for="allowSettingsAfterFormatInInsertCheck"
                                       data-toggle="tooltip" data-placement="left"
                                       title="Allow SETTINGS after FORMAT (not always safe)">Allow SETTINGS after
                                    FORMAT</label>
                            </div>
                            <div class="form-group mb-2">
                                <label for="maxLineLengthInput" data-toggle="tooltip" data-placement="left"
                                       title="Max line length before wrapping">Max Line Length:</label>
                                <input type="number" class="form-control form-control-sm" id="maxLineLengthInput"
                                       placeholder="120">
                            </div>
                            <div class="form-group mb-2">
                                <label for="maxQuerySizeInput" data-toggle="tooltip" data-placement="left"
                                       title="Maximum bytes of a query parsed by the SQL parser.">Max Query Size
                                    (bytes):</label>
                                <input type="number" class="form-control form-control-sm" id="maxQuerySizeInput"
                                       placeholder="262144">
                            </div>
                            <div class="form-group mb-0">
                                <label for="maxParserDepthInput" data-toggle="tooltip" data-placement="left"
                                       title="Maximum parser recursion depth.">Max Parser Depth:</label>
                                <input type="number" class="form-control form-control-sm" id="maxParserDepthInput"
                                       placeholder="1000">
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Theme Toggle Button -->
                <button class="btn btn-outline-secondary theme-toggle" type="button" id="themeToggleBtn"
                        data-toggle="tooltip" data-placement="bottom" title="Toggle Theme">
                    <i class="fa fa-moon-o" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Separator is now just an hr with CSS styling -->
    <hr>

    <div class="row sql-areas">
        <div class="col-md-6 mb-3 mb-md-0">
            <div class="editor-container">
                <span class="editor-label">Input SQL</span>
                <textarea id="sqlInput"></textarea>
            </div>
        </div>
        <div class="col-md-6">
            <div class="editor-container">
                <span class="editor-label">Formatted Output</span>
                <div id="sqlOutput"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/sql/sql.min.js"></script>

<script type="text/javascript">
    $(function () {

        const initialTheme = localStorage.getItem('sqlFormatterTheme') || 'light';
        const editorThemes = {light: 'eclipse', dark: 'material-darker'};
        // --- Initialize UI Elements ---
        const elements = {
            editor: CodeMirror.fromTextArea(document.getElementById("sqlInput"), {
                lineNumbers: true,
                mode: "text/x-sql",
                theme: editorThemes[initialTheme],
                matchBrackets: true,
                smartIndent: true,
                indentWithTabs: false,
                tabSize: 4,
                autoCloseBrackets: true,
                styleActiveLine: true,
                lineWrapping: true,
                placeholder: "Paste your ClickHouse SQL here...",
                extraKeys: {"Ctrl-Enter": formatRequest}
            }),
            output: $('#sqlOutput'),
            hilite: $('#hiliteCheck'),
            oneline: $('#onelineCheck'),
            multiquery: $('#multiqueryCheck'),
            backslash: $('#backslashCheck'),
            allowSettingsAfterFormatInInsert: $('#allowSettingsAfterFormatInInsertCheck'),
            obfuscate: $('#obfuscateCheck'),
            comments: $('#commentsCheck'),
            seed: $('#seedInput'),
            maxQuerySize: $('#maxQuerySizeInput'),
            maxParserDepth: $('#maxParserDepthInput'),
            maxLineLength: $('#maxLineLengthInput'),
            autoFormat: $('#autoFormatCheck'),
            formatBtn: $('#formatBtn'),
            clearBtn: $('#clearBtn'),
            undoBtn: $('#undoBtn'),
            redoBtn: $('#redoBtn'),
            copyBtn: $('#copyBtn'),
            themeToggleBtn: $('#themeToggleBtn')
        };

        // --- Core Formatting Logic ---
        const getOptions = function () {
            const obj = {
                hilite: elements.hilite.prop('checked'),
                oneline: elements.oneline.prop('checked'),
                comments: elements.comments.prop('checked'),
                multiquery: elements.multiquery.prop('checked'),
                backslash: elements.backslash.prop('checked'),
                allowSettingsAfterFormatInInsert: elements.allowSettingsAfterFormatInInsert.prop('checked'),
                obfuscate: elements.obfuscate.prop('checked'),
                seed: elements.seed.val(),
                maxQuerySize: elements.maxQuerySize.val(),
                maxParserDepth: elements.maxParserDepth.val(),
                maxLineLength: elements.maxLineLength.val()
            };
            // Clean up empty/false options before sending
            for (let key in obj) {
                const val = obj[key];
                if (val === '' || val === null || val === undefined || val === false) {
                    delete obj[key];
                }
            }
            return obj;
        };

        // NOTE on ansi_up: It converts terminal color codes to HTML.
        // CSS for #sqlOutput must be careful not to override the inline styles generated by this.
        const highlighter = new AnsiUp();

        function formatRequest() {
            const sql = elements.editor.getValue().trim();
            if (!sql) return;

            elements.output.html('<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>');
            const options = getOptions();

            $.ajax({
                url: 'api/format?' + $.param(options),
                method: 'POST',
                contentType: "text/plain; charset=utf-8",
                data: sql,
                dataType: 'text'
            }).done(function (data) {
                gtag('event', 'format_success', {'inputLength': sql.length, 'outputLength': data.length});
                if (options.hilite) {
                    // IMPORTANT: Let ansi_up handle the HTML generation for colored output.
                    elements.output.html(highlighter.ansi_to_html(data));
                } else {
                    // For non-highlighted, wrap in a <code> tag for semantic correctness and styling hooks.
                    elements.output.html($('<code>').text(data));
                }
            }).fail(function (xhr, status, error) {
                gtag('event', 'format_error', {'inputLength': sql.length, 'status': status, 'error': error});
                elements.output.html($('<p>').addClass('text-danger').text(xhr.responseText));
            });
        }

        // --- UX Enhancements & Event Handlers ---

        // Auto-format with debounce
        let autoFormatTimer = null;
        elements.editor.on('change', function (cm, change) {
            if (autoFormatTimer) clearTimeout(autoFormatTimer);
            if (elements.autoFormat.prop('checked')) {
                autoFormatTimer = setTimeout(formatRequest, 350);
            }
            // Disable clear button if editor is empty
            const hasText = cm.getValue().length > 0;
            elements.clearBtn.prop('disabled', !hasText);
        });

        elements.formatBtn.on('click', formatRequest);

        // Clear button
        elements.clearBtn.on('click', function () {
            elements.editor.setValue('');
            elements.output.empty();
            elements.editor.focus();
        });

        // Undo/Redo
        elements.undoBtn.on('click', () => elements.editor.undo());
        elements.redoBtn.on('click', () => elements.editor.redo());

        // Copy button feedback
        const clipboard = new ClipboardJS('#copyBtn');
        clipboard.on('success', function (e) {
            const originalIcon = 'fa-clipboard';
            const successIcon = 'fa-check';
            const $icon = $(e.trigger).find('.fa');

            $icon.removeClass(originalIcon).addClass(successIcon);
            $(e.trigger).tooltip('hide').attr('data-original-title', 'Copied!').tooltip('show');

            setTimeout(function () {
                $icon.removeClass(successIcon).addClass(originalIcon);
                $(e.trigger).tooltip('hide').attr('data-original-title', 'Copy to Clipboard');
            }, 2000);
            e.clearSelection();
        });

        // Tooltips Initialization (with container to prevent clipping issues)
        $('[data-toggle="tooltip"]').tooltip({container: 'body'});

        $('.dropdown-menu [data-toggle="tooltip"]').tooltip({
            container: 'body',
            delay: {"show": 150, "hide": 100}
        });

        // --- Theme Toggling ---
        const themeIcon = {light: 'fa-moon-o', dark: 'fa-sun-o'};

        function applyTheme(theme) {
            $('body').attr('data-theme', theme);
            elements.themeToggleBtn.find('.fa').removeClass().addClass(`fa ${themeIcon[theme]}`);
            localStorage.setItem('sqlFormatterTheme', theme);
            // ADD THIS LINE: This tells the editor to switch its theme.
            elements.editor.setOption('theme', editorThemes[theme]);
        }

        elements.themeToggleBtn.on('click', function () {
            const currentTheme = $('body').attr('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        });

        // Load saved theme on page load
        applyTheme(initialTheme);

        // Initial check for clear button state
        elements.clearBtn.prop('disabled', elements.editor.getValue().length === 0);
    });
</script>
</body>
</html>