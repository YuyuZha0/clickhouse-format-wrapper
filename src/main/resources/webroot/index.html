<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CCS6CPTZW9"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-CCS6CPTZW9');
    </script>
    <!--<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3063309143016305"
            crossorigin="anonymous"></script>
    <script type="text/javascript" data-cmp-ab="1"
            src="https://cdn.consentmanager.net/delivery/autoblocking/cf704ffdf1a25.js"
            data-cmp-host="c.delivery.consentmanager.net" data-cmp-cdn="cdn.consentmanager.net"
            data-cmp-codesrc="16"></script>-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="Free online clickhouse sql formatter, support highlighting, compatible with clickhouse-format"/>
    <meta name="keywords" content="clickhouse, sql, formatter, highlight, clickhouse-format"/>
    <title>Online Clickhouse SQL Formatter</title>
    <link rel="icon" type="image/x-icon" href="https://clickhouse.com/docs/img/docs_favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css"
          integrity="sha512-uf06llspW44/LZpHzHT6qBOIVODjWtv4MxCricRxkzvopAlSWnTf6hpZTFxuuZcuNE9CBQhqE0Seu1CoRk84nQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/material.min.css"
          integrity="sha512-jA21084nir3cN96YuzJ1DbtDn30kxhxqQToAzCEGZcuRAswWfYirpUu8HVm8wRNoWDCYtA4iavd2Rb1bQSLv7g=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa; /* Light background for the page */
            padding-top: 1rem; /* Add some space at the top */
        }

        .main-container {
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px; /* Add padding at the bottom */
        }

        h3 {
            color: #343a40; /* Darker heading color */
            border-bottom: 1px solid #dee2e6; /* Add a subtle separator line below heading */
        }

        /* Control Panel Styling */
        .control-panel {
            display: flex;
            flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            align-items: center;
            gap: 0.5rem; /* Space between buttons/dropdown */
            background-color: #ffffff; /* White background for the panel */
            padding: 0.75rem 1rem; /* More padding */
            border-radius: 0.25rem; /* Rounded corners */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            margin-bottom: 1rem; /* Space below the control panel */
        }

        .control-panel .btn {
            /* Optional: Adjust button padding or size if needed */
        }

        .dropdown-menu {
            max-height: 400px; /* Limit dropdown height */
            overflow-y: auto; /* Add scroll if options exceed max height */
        }

        /* Spacing within the dropdown form */
        .dropdown-menu form .form-check {
            margin-bottom: 0.5rem; /* Space below checkboxes */
        }

        .dropdown-menu form .form-check:last-of-type {
            margin-bottom: 0.75rem; /* More space before divider/inputs */
        }

        .dropdown-menu form .form-group {
            margin-bottom: 0.75rem; /* Space below input groups */
        }

        .dropdown-menu form .form-group:last-of-type {
            margin-bottom: 0.25rem; /* Less space at the very bottom */
        }

        .dropdown-menu form label {
            font-size: 0.9em; /* Slightly smaller labels */
            margin-bottom: 0.25rem; /* Space between label and input/check */
        }

        /* SQL Editor Areas */
        .sql-areas {
            /* The row itself doesn't need much styling, columns handle it */
        }

        /* Style the CodeMirror editor */
        .CodeMirror {
            border: 1px solid #ced4da;
            height: 50vh; /* Make editors take significant vertical space */
            min-height: 300px; /* Minimum height */
            font-size: 0.95em;
            border-radius: 0.25rem;
        }

        /* Style the output area */
        #sqlOutput {
            border: 1px solid #ced4da;
            height: 50vh; /* Match input editor height */
            min-height: 300px; /* Minimum height */
            background-color: #e9ecef; /* Slightly different background for output */
            padding: 10px;
            font-family: Consolas, "Courier New", monospace; /* Monospace font for SQL */
            font-size: 0.95em;
            overflow-y: auto; /* Scroll if content overflows */
            white-space: pre-wrap; /* Preserve whitespace and wrap */
            word-break: break-all; /* Break long lines */
            border-radius: 0.25rem;
            line-height: 1.4;
        }

        /* Styling for non-highlighted output within the div */
        #sqlOutput code {
            display: block; /* Ensure code block takes full width */
            white-space: pre-wrap; /* Inherit wrapping */
            word-break: break-all; /* Inherit breaking */
            color: #212529; /* Default text color */
        }

        /* Style error messages in output */
        #sqlOutput p.text-danger {
            margin: 0; /* Remove default paragraph margin */
            font-weight: bold;
        }

        /* Style the loading spinner container */
        #sqlOutput .d-flex {
            height: 100%; /* Center spinner vertically */
            align-items: center;
        }

        /* Separator */
        hr {
            margin-top: 1rem;
            margin-bottom: 1.5rem; /* Add more space around the separator */
        }

        /* Ensure tooltips are visible */
        .tooltip-inner {
            max-width: 250px; /* Prevent tooltips from becoming too wide */
            background-color: #343a40; /* Darker tooltip background */
            color: #ffffff; /* White text */
        }

        .tooltip.bs-tooltip-auto[x-placement^=bottom] .arrow::before,
        .tooltip.bs-tooltip-bottom .arrow::before {
            border-bottom-color: #343a40; /* Match arrow color */
        }

        .tooltip.bs-tooltip-auto[x-placement^=top] .arrow::before,
        .tooltip.bs-tooltip-top .arrow::before {
            border-top-color: #343a40;
        }

        .tooltip.bs-tooltip-auto[x-placement^=right] .arrow::before,
        .tooltip.bs-tooltip-right .arrow::before {
            border-right-color: #343a40;
        }

        .tooltip.bs-tooltip-auto[x-placement^=left] .arrow::before,
        .tooltip.bs-tooltip-left .arrow::before {
            border-left-color: #343a40;
        }

        /* Minor adjustment for mobile */
        @media (max-width: 767.98px) {
            .CodeMirror, #sqlOutput {
                height: 40vh; /* Slightly reduce height on mobile */
                min-height: 250px;
            }

            .control-panel {
                padding: 0.5rem 0.75rem; /* Less padding on mobile */
            }
        }
    </style>
</head>
<body>
<div class="container-fluid main-container">
    <h3 class="pb-2 mb-3">Online Clickhouse SQL Formatter</h3> <!-- Adjusted bottom margin -->

    <!-- Control Panel Row -->
    <div class="row">
        <div class="col-12">
            <div class="control-panel py-1"> <!-- Added padding and flex container -->
                <!-- Buttons and Dropdown (removed form-group wrappers, using gap now) -->
                <button class="btn btn-outline-secondary" type="button" id="formatBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Run Format">
                    <i class="fa fa-play" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="copyBtn" data-clipboard-target="#sqlOutput"
                        data-toggle="tooltip" data-placement="bottom" title="Copy to Clipboard">
                    <i class="fa fa-clipboard" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="clearBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Clear">
                    <i class="fa fa-trash" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="undoBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Undo">
                    <i class="fa fa-undo" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="redoBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Redo">
                    <i class="fa fa-repeat" aria-hidden="true"></i>
                </button>
                <a href="https://clickhouse.com/docs/en/sql-reference" class="btn btn-outline-secondary" target="_blank"
                   data-toggle="tooltip" data-placement="bottom" title="SQL Reference">
                    <i class="fa fa-book"></i>
                </a>

                <!-- Dropdown -->
                <div class="dropdown"> <!-- Keep dropdown wrapper -->
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenu2"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <i class="fa fa-bars" aria-hidden="true"></i> Options
                    </button>
                    <div class="dropdown-menu" aria-labelledby="dropdownMenu2">
                        <!-- Using px/py inside form is okay if dropdown-menu padding isn't sufficient -->
                        <form class="px-3 py-2">
                            <!-- Form Check examples (Apply similar structure to all) -->
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="autoFormatCheck">
                                <label class="form-check-label" for="autoFormatCheck" data-toggle="tooltip"
                                       data-placement="right" title="Enable auto format">Auto Format</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" checked="checked" class="form-check-input" id="hiliteCheck">
                                <label class="form-check-label" for="hiliteCheck" data-toggle="tooltip"
                                       data-placement="right"
                                       title="Add syntax highlight with ANSI terminal escape sequences">Highlight
                                    (ANSI)</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" checked="checked" class="form-check-input" id="commentsCheck">
                                <label class="form-check-label" for="commentsCheck" data-toggle="tooltip"
                                       data-placement="right"
                                       title="Keep comments in the output">Keep Comments</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="onelineCheck">
                                <label class="form-check-label" for="onelineCheck" data-toggle="tooltip"
                                       data-placement="right"
                                       title="Format in single line">Single Line</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="multiqueryCheck">
                                <label class="form-check-label" for="multiqueryCheck" data-toggle="tooltip"
                                       data-placement="right"
                                       title="Allow multiple queries in the same file">Allow Multi-query</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="backslashCheck">
                                <label class="form-check-label" for="backslashCheck" data-toggle="tooltip"
                                       data-placement="right"
                                       title="Add a backslash at the end of each line of the formatted query">Add
                                    Backslashes</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input"
                                       id="allowSettingsAfterFormatInInsertCheck">
                                <label class="form-check-label"
                                       for="allowSettingsAfterFormatInInsertCheck" data-toggle="tooltip"
                                       data-placement="right"
                                       title="Allow SETTINGS after FORMAT, but note, that this is not always safe">Allow
                                    SETTINGS after FORMAT</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="obfuscateCheck">
                                <label class="form-check-label" for="obfuscateCheck" data-toggle="tooltip"
                                       data-placement="right"
                                       title="Obfuscate instead of formatting">Obfuscate</label>
                            </div>

                            <!-- Form Group examples (Apply similar structure to all) -->
                            <div class="dropdown-divider"></div> <!-- Separator -->
                            <div class="form-group">
                                <label for="maxLineLengthInput" data-toggle="tooltip" data-placement="right"
                                       title="Format in single line queries with length less than specified">Max Line
                                    Length:</label>
                                <input type="number" class="form-control" id="maxLineLengthInput"
                                       placeholder="e.g., 120">
                            </div>
                            <div class="form-group">
                                <label for="seedInput" data-toggle="tooltip" data-placement="right"
                                       title="Seed (arbitrary string) that determines the result of obfuscation">Obfuscation
                                    Seed:</label>
                                <input type="text" class="form-control" id="seedInput">
                            </div>
                            <div class="form-group">
                                <label for="maxQuerySizeInput" data-toggle="tooltip" data-placement="right"
                                       title="The maximum number of bytes of a query string parsed by the SQL parser.">Max
                                    Query Size (bytes):</label>
                                <input type="number" class="form-control" id="maxQuerySizeInput"
                                       placeholder="e.g., 262144">
                            </div>
                            <div class="form-group">
                                <label for="maxParserDepthInput" data-toggle="tooltip" data-placement="bottom"
                                       title="Maximum parser depth (recursion depth of recursive descend parser).">Max
                                    Parser Depth:</label>
                                <input type="number" class="form-control" id="maxParserDepthInput"
                                       placeholder="e.g., 1000">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr> <!-- Separator -->

    <!-- SQL Input/Output Row -->
    <div class="row sql-areas">
        <div class="col-md-6 mb-3 mb-md-0"> <!-- Add bottom margin on mobile -->
            <label for="sqlInput" class="sr-only">Source SQL Input</label> <!-- Screen reader label -->
            <textarea id="sqlInput" class="sql-editor"></textarea>
            <!-- Added class -->
        </div>
        <div class="col-md-6">
            <label for="sqlOutput" class="sr-only">Formatted SQL Output</label> <!-- Screen reader label -->
            <div id="sqlOutput" class="sql-editor"></div> <!-- Added class -->
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"
        integrity="sha512-6cPYokihlrofMNApz7OXVQNObWjLiKGIBBb7+UB+AuMiRCLKmFKgrwms21sHq3bdFFZWpfHYRJBJvMFMPj1S9g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
    $(function () {

        $('[data-toggle="tooltip"]').tooltip();

        const elements = Object.freeze({
            editor: CodeMirror.fromTextArea(document.getElementById("sqlInput"), {
                lineNumbers: true,             // Keep: Essential for referencing lines
                mode: "text/x-sql",            // Use generic SQL mode (often better supported) or stick with "text/x-clickhouse" if specific features are needed and available
                theme: "material",             // Keep: Matches the included theme CSS
                matchBrackets: true,           // Keep: Helps match parentheses, brackets
                //indentUnit: 4,               // Keep: Standard indentation size (adjust if preferred) - This is often inferred correctly with smartIndent
                smartIndent: true,             // Keep: Enables context-aware indentation
                indentWithTabs: false,         // Added: Use spaces instead of tabs for indentation
                tabSize: 4,                    // Added: Ensure tab key inserts 4 spaces (aligns with indentUnit)
                autoCloseBrackets: true,       // Added: Automatically close brackets and quotes ( '(', '[', '{', "'", '"' )
                styleActiveLine: true,         // Added: Highlights the entire line the cursor is on
                lineWrapping: true,            // Added: Wraps long lines instead of requiring horizontal scrolling
                placeholder: "Paste your ClickHouse SQL here...", // Added: Use CodeMirror's placeholder instead of the textarea's (often renders better)
            }),
            output: $('#sqlOutput'),
            hilite: $('#hiliteCheck'),
            oneline: $('#onelineCheck'),
            multiquery: $('#multiqueryCheck'),
            backslash: $('#backslashCheck'),
            allowSettingsAfterFormatInInsert: $('#allowSettingsAfterFormatInInsertCheck'),
            obfuscate: $('#obfuscateCheck'),
            comments: $('#commentsCheck'),
            seed: $('#seedInput'),
            maxQuerySize: $('#maxQuerySizeInput'),
            maxParserDepth: $('#maxParserDepthInput'),
            maxLineLength: $('#maxLineLengthInput'),
            autoFormat: $('#autoFormatCheck'),
            formatBtn: $('#formatBtn'),
            clearBtn: $('#clearBtn'),
            undoBtn: $('#undoBtn'),
            redoBtn: $('#redoBtn'),
            copyBtn: $('#copyBtn'),
        });


        const getOptions = function () {
            const obj = {
                hilite: elements.hilite.prop('checked'),
                oneline: elements.oneline.prop('checked'),
                comments: elements.comments.prop('checked'),
                multiquery: elements.multiquery.prop('checked'),
                backslash: elements.backslash.prop('checked'),
                allowSettingsAfterFormatInInsert: elements.allowSettingsAfterFormatInInsert.prop('checked'),
                obfuscate: elements.obfuscate.prop('checked'),
                seed: elements.seed.val(),
                maxQuerySize: elements.maxQuerySize.val(),
                maxParserDepth: elements.maxParserDepth.val(),
                maxLineLength: elements.maxLineLength.val()
            };
            for (let key in obj) {
                const val = obj[key];
                if (val === '' || val === null || val === undefined || val === false) {
                    delete obj[key];
                }
            }
            return obj;
        };

        const createHighlighter = function () {
            if (window.AnsiUp) {
                const ansiUp = new AnsiUp();
                return function (text) {
                    return ansiUp.ansi_to_html(text);
                };
            } else {
                console.warn('AnsiUp not available!');
                return function (text) {
                    return text;
                };
            }
        };

        const isNotBlank = function (str) {
            return (typeof str === 'string' || str instanceof String)
                && str.length > 0 && str.trim().length > 0;
        };


        const highlighter = createHighlighter();
        const formatRequest = function () {
            const sql = elements.editor.getValue();
            if (!isNotBlank(sql)) {
                return;
            }
            StageManager.save();
            elements.output.html('<div class="d-flex justify-content-center"><div class="spinner-border text-info" role="status"><span class="sr-only">Loading...</span></div></div>');
            const options = getOptions();
            $.ajax({
                url: 'api/format?' + $.param(options),
                method: 'POST',
                contentType: "text/plain; charset=utf-8",
                data: sql,
                dataType: 'text'
            }).done(function (data) {
                gtag('event', 'format_success', {
                    'inputLength': sql.length,
                    'outputLength': data.length
                });
                if (typeof data === 'string' || data instanceof String) {
                    if (options.hilite) {
                        elements.output.html(highlighter(data));
                    } else {
                        elements.output.html(`<code>${data}</code>`);
                    }
                }
            }).fail(function (xhr, status, error) {
                gtag('event', 'format_error', {
                    'inputLength': sql.length,
                    'status': status,
                    'error': error
                });
                elements.output.html(`<p class="text-danger">${xhr.responseText}</p>`);
            });
        };


        let timer = null;
        elements.editor.on('change', function () {
            if (timer) {
                clearTimeout(timer);
                timer = null;
            }
            if (elements.autoFormat.prop('checked')) {
                timer = setTimeout(formatRequest, 200);
            }
        });
        elements.formatBtn.on('click', formatRequest);

        const initClipboard = function () {
            if (window.ClipboardJS) {
                new ClipboardJS('#copyBtn');
            } else {
                console.warn('Clipboard not available!');
            }
        };
        initClipboard();

        elements.clearBtn.on('click', function () {
            elements.editor.setValue('');
            elements.output.empty();
            elements.editor.focus();
        });
        elements.undoBtn.on('click', function () {
            elements.editor.undo();
        });
        elements.redoBtn.on('click', function () {
            elements.editor.redo();
        });
    });
</script>
</body>
</html>