<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CCS6CPTZW9"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());
        gtag('config', 'G-CCS6CPTZW9');
    </script>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="Free online clickhouse sql formatter, support highlighting, compatible with clickhouse-format"/>
    <meta name="keywords" content="clickhouse, sql, formatter, highlight, clickhouse-format"/>
    <title>Online Clickhouse SQL Formatter</title>
    <link rel="icon" type="image/x-icon" href="https://clickhouse.com/docs/img/docs_favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
    <!-- CodeMirror Themes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/eclipse.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/material-darker.min.css">
    <style>
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-color: #f8f9fa;
            --bg-color-medium: #ffffff;
            --bg-color-footer: #e9ecef;
            --text-color: #212529;
            --text-color-muted: #6c757d;
            --heading-color: #343a40;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --primary-color: #007bff;
            --button-outline-color: #6c757d;
            --button-hover-bg: #e9ecef;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --bg-color-medium: #2c2c2c;
            --bg-color-footer: #252525;
            --text-color: #e0e0e0;
            --text-color-muted: #adb5bd;
            --heading-color: #f8f9fa;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --primary-color: #0d6efd;
            --button-outline-color: #adb5bd;
            --button-hover-bg: #495057;
        }

        /* --- Layout --- */
        html, body {
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        .main-container {
            flex: 1 0 auto;
            padding: 1rem 1.5rem;
        }

        /* --- Header & Footer --- */
        .page-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom-color: var(--border-color) !important;
        }

        .page-header img {
            width: 32px;
            height: 32px;
        }

        .page-header h3 {
            margin-bottom: 0;
            color: var(--heading-color);
        }

        .footer {
            flex-shrink: 0;
            background-color: var(--bg-color-footer);
            color: var(--text-color-muted);
            font-size: 0.9rem;
        }

        .footer a {
            color: var(--text-color);
            text-decoration: none;
        }

        .footer a:hover {
            color: var(--primary-color);
        }

        /* --- Control Panel --- */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--bg-color-medium);
            padding: 0.75rem 1rem;
            border-radius: 0.3rem;
            box-shadow: 0 1px 3px var(--shadow-color);
            border: 1px solid var(--border-color);
            margin-top: 1rem;
        }

        .control-panel .btn-outline-secondary {
            color: var(--button-outline-color);
            border-color: var(--button-outline-color);
        }

        .control-panel .btn-outline-secondary:hover {
            background-color: var(--button-hover-bg);
        }

        /* --- Dropdown Menu --- */
        .dropdown-menu {
            max-height: 450px;
            overflow-y: auto;
            background-color: var(--bg-color-medium);
            border-color: var(--border-color);
        }

        .dropdown-menu .dropdown-divider {
            border-top-color: var(--border-color);
        }

        .dropdown-menu .form-check, .dropdown-menu .form-group {
            margin-bottom: 0.75rem;
        }

        .dropdown-menu label {
            font-size: 0.9em;
            color: var(--text-color);
        }

        .dropdown-menu .form-control {
            background-color: var(--bg-color);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        .dropdown-menu .form-control:focus {
            background-color: var(--bg-color);
        }

        /* --- Tooltip Flicker Fix --- */
        .tooltip {
            pointer-events: none;
        }

        /* --- Editors --- */
        .editor-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-color-muted);
            margin-bottom: 0.5rem;
        }

        .CodeMirror {
            border: 1px solid var(--border-color);
            height: 65vh;
            font-size: 0.95em;
            border-radius: 0.3rem;
        }

        #sqlOutput {
            border: 1px solid var(--border-color);
            height: 65vh;
            background-color: var(--bg-color-medium);
            padding: 10px;
            font-family: Consolas, "Courier New", monospace;
            font-size: 0.95em;
            overflow-y: auto;
            border-radius: 0.3rem;
            line-height: 1.5;
            display: flex; /* For placeholder centering */
            flex-direction: column;
        }

        #sqlOutput .placeholder-text {
            color: var(--text-color-muted);
            margin: auto;
            text-align: center;
        }

        #sqlOutput code {
            white-space: pre-wrap;
            word-break: break-all;
        }

        #sqlOutput p.text-danger {
            margin: 0;
            font-weight: bold;
        }

        #sqlOutput .spinner-border {
            color: var(--primary-color) !important;
        }

        /* --- Mobile Adjustments --- */
        @media (max-width: 767.98px) {
            .CodeMirror, #sqlOutput {
                height: 40vh;
            }

            .main-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body data-theme="light">

<div class="container-fluid main-container">
    <header class="page-header pb-2 mb-2 border-bottom">
        <img src="https://clickhouse.com/docs/img/docs_favicon.ico" alt="ClickHouse logo">
        <h3>Online Clickhouse SQL Formatter</h3>
    </header>

    <div class="row">
        <div class="col-12">
            <div class="control-panel">
                <button class="btn btn-primary" type="button" id="formatBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Format SQL (Ctrl+Enter)">
                    <i class="fa fa-play" aria-hidden="true"></i> Format
                </button>
                <button class="btn btn-outline-secondary" type="button" id="copyBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Copy to Clipboard">
                    <i class="fa fa-clipboard" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="clearBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Clear Editors">
                    <i class="fa fa-trash" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="undoBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Undo (Ctrl+Z)">
                    <i class="fa fa-undo" aria-hidden="true"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" id="redoBtn" data-toggle="tooltip"
                        data-placement="bottom" title="Redo (Ctrl+Y)">
                    <i class="fa fa-repeat" aria-hidden="true"></i>
                </button>
                <a href="https://clickhouse.com/docs/en/sql-reference" class="btn btn-outline-secondary" target="_blank"
                   rel="noopener" data-toggle="tooltip" data-placement="bottom" title="ClickHouse SQL Reference">
                    <i class="fa fa-book"></i>
                </a>

                <button class="btn btn-outline-secondary ml-auto" type="button" id="themeToggleBtn"
                        data-toggle="tooltip" data-placement="bottom" title="Toggle Theme">
                    <i class="fa fa-moon-o" aria-hidden="true"></i>
                </button>

                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="dropdownMenu2"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-toggle="tooltip"
                            data-placement="bottom" title="Formatting Options">
                        <i class="fa fa-cog" aria-hidden="true"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenu2">
                        <form class="px-3 py-2">
                            <div class="form-check" data-toggle="tooltip" data-placement="left"
                                 title="Enable auto format on text change">
                                <input type="checkbox" class="form-check-input" id="autoFormatCheck">
                                <label class="form-check-label" for="autoFormatCheck">Auto Format</label>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="form-check" data-toggle="tooltip" data-placement="left"
                                 title="Add syntax highlight with ANSI terminal escape sequences">
                                <input type="checkbox" checked="checked" class="form-check-input" id="hiliteCheck">
                                <label class="form-check-label" for="hiliteCheck">Highlight (ANSI)</label>
                            </div>
                            <div class="form-check" data-toggle="tooltip" data-placement="left"
                                 title="Keep comments in the output">
                                <input type="checkbox" checked="checked" class="form-check-input" id="commentsCheck">
                                <label class="form-check-label" for="commentsCheck">Keep Comments</label>
                            </div>
                            <div class="form-check" data-toggle="tooltip" data-placement="left"
                                 title="Format in single line">
                                <input type="checkbox" class="form-check-input" id="onelineCheck">
                                <label class="form-check-label" for="onelineCheck">Single Line</label>
                            </div>
                            <div class="form-check" data-toggle="tooltip" data-placement="left"
                                 title="Allow multiple queries in the same file">
                                <input type="checkbox" class="form-check-input" id="multiqueryCheck">
                                <label class="form-check-label" for="multiqueryCheck">Allow Multi-query</label>
                            </div>
                            <div class="form-check" data-toggle="tooltip" data-placement="left"
                                 title="Add a backslash at the end of each line">
                                <input type="checkbox" class="form-check-input" id="backslashCheck">
                                <label class="form-check-label" for="backslashCheck">Add Backslashes</label>
                            </div>
                            <div class="form-check" data-toggle="tooltip" data-placement="left"
                                 title="Allow SETTINGS after FORMAT (not always safe)">
                                <input type="checkbox" class="form-check-input"
                                       id="allowSettingsAfterFormatInInsertCheck">
                                <label class="form-check-label" for="allowSettingsAfterFormatInInsertCheck">Allow
                                    SETTINGS after FORMAT</label>
                            </div>
                            <div class="form-check" data-toggle="tooltip" data-placement="left"
                                 title="Obfuscate instead of formatting">
                                <input type="checkbox" class="form-check-input" id="obfuscateCheck">
                                <label class="form-check-label" for="obfuscateCheck">Obfuscate</label>
                            </div>
                            <div class="dropdown-divider"></div>
                            <div class="form-group" data-toggle="tooltip" data-placement="left"
                                 title="Format in single line queries with length less than specified">
                                <label for="maxLineLengthInput">Max Line Length:</label>
                                <input type="number" class="form-control form-control-sm" id="maxLineLengthInput"
                                       placeholder="120">
                            </div>
                            <div class="form-group" data-toggle="tooltip" data-placement="left"
                                 title="Seed that determines the result of obfuscation">
                                <label for="seedInput">Obfuscation Seed:</label>
                                <input type="text" class="form-control form-control-sm" id="seedInput">
                            </div>
                            <div class="form-group" data-toggle="tooltip" data-placement="left"
                                 title="The maximum number of bytes of a query parsed by the SQL parser.">
                                <label for="maxQuerySizeInput">Max Query Size (bytes):</label>
                                <input type="number" class="form-control form-control-sm" id="maxQuerySizeInput"
                                       placeholder="262144">
                            </div>
                            <div class="form-group mb-0" data-toggle="tooltip" data-placement="left"
                                 title="Maximum parser depth (recursion depth of recursive descend parser).">
                                <label for="maxParserDepthInput">Max Parser Depth:</label>
                                <input type="number" class="form-control form-control-sm" id="maxParserDepthInput"
                                       placeholder="1000">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row sql-areas mt-3">
        <div class="col-md-6 mb-3 mb-md-0">
            <label class="editor-label" for="sqlInput">Source SQL</label>
            <textarea id="sqlInput"></textarea>
        </div>
        <div class="col-md-6">
            <label class="editor-label" for="sqlOutput">Formatted Output</label>
            <div id="sqlOutput"></div>
        </div>
    </div>
</div>

<footer class="footer mt-auto py-3 text-center">
    <div class="container">
        <span>Powered by <a href="https://clickhouse.com/docs/en/operations/utilities/clickhouse-format" target="_blank"
                            rel="noopener">clickhouse-format</a>.</span>
        <span>View on <a href="https://github.com/YuyuZha0/clickhouse-format-wrapper" target="_blank"
                         rel="noopener"><i class="fa fa-github"></i> GitHub</a>.</span>
    </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ansi_up@5.1.0/ansi_up.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/sql/sql.min.js"></script>

<script type="text/javascript">
    $(function () {
        const initialTheme = localStorage.getItem('sqlFormatterTheme') || 'light';
        const editorThemes = {light: 'eclipse', dark: 'material-darker'};

        const elements = {
            editor: CodeMirror.fromTextArea(document.getElementById("sqlInput"), {
                lineNumbers: true,
                mode: "text/x-sql",
                theme: editorThemes[initialTheme],
                matchBrackets: true,
                smartIndent: true,
                indentWithTabs: false,
                tabSize: 4,
                autoCloseBrackets: true,
                styleActiveLine: true,
                lineWrapping: true,
                placeholder: "Paste your ClickHouse SQL here...",
                extraKeys: {"Ctrl-Enter": formatRequest, "Cmd-Enter": formatRequest}
            }),
            output: $('#sqlOutput'),
            hilite: $('#hiliteCheck'),
            oneline: $('#onelineCheck'),
            multiquery: $('#multiqueryCheck'),
            backslash: $('#backslashCheck'),
            allowSettingsAfterFormatInInsert: $('#allowSettingsAfterFormatInInsertCheck'),
            obfuscate: $('#obfuscateCheck'),
            comments: $('#commentsCheck'),
            seed: $('#seedInput'),
            maxQuerySize: $('#maxQuerySizeInput'),
            maxParserDepth: $('#maxParserDepthInput'),
            maxLineLength: $('#maxLineLengthInput'),
            autoFormat: $('#autoFormatCheck'),
            formatBtn: $('#formatBtn'),
            clearBtn: $('#clearBtn'),
            undoBtn: $('#undoBtn'),
            redoBtn: $('#redoBtn'),
            copyBtn: $('#copyBtn'),
            themeToggleBtn: $('#themeToggleBtn')
        };

        const outputPlaceholder = '<div class="placeholder-text">Formatted SQL will appear here</div>';
        const highlighter = new AnsiUp();

        const getOptions = function () {
            const obj = {
                hilite: elements.hilite.prop('checked'),
                oneline: elements.oneline.prop('checked'),
                comments: elements.comments.prop('checked'),
                multiquery: elements.multiquery.prop('checked'),
                backslash: elements.backslash.prop('checked'),
                allowSettingsAfterFormatInInsert: elements.allowSettingsAfterFormatInInsert.prop('checked'),
                obfuscate: elements.obfuscate.prop('checked'),
                seed: elements.seed.val(),
                maxQuerySize: elements.maxQuerySize.val(),
                maxParserDepth: elements.maxParserDepth.val(),
                maxLineLength: elements.maxLineLength.val()
            };
            for (let key in obj) {
                if (!obj[key]) {
                    delete obj[key];
                }
            }
            return obj;
        };

        function formatRequest() {
            const sql = elements.editor.getValue().trim();
            if (!sql) return;

            elements.output.html('<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>');
            const options = getOptions();

            $.ajax({
                url: 'api/format?' + $.param(options),
                method: 'POST',
                contentType: "text/plain; charset=utf-8",
                data: sql,
                dataType: 'text'
            }).done(function (data) {
                gtag('event', 'format_success', {'inputLength': sql.length, 'outputLength': data.length});
                if (options.hilite) {
                    elements.output.html(highlighter.ansi_to_html(data));
                } else {
                    elements.output.html($('<code/>').text(data));
                }
                elements.output.attr('data-clipboard-text', data);
            }).fail(function (xhr) {
                gtag('event', 'format_error', {'inputLength': sql.length, 'status': xhr.status});
                elements.output.html(`<p class="text-danger">${xhr.responseText || 'An unknown error occurred.'}</p>`);
                elements.output.removeAttr('data-clipboard-text');
            });
        }

        let autoFormatTimer = null;
        elements.editor.on('change', function () {
            if (autoFormatTimer) clearTimeout(autoFormatTimer);
            if (elements.autoFormat.prop('checked')) {
                autoFormatTimer = setTimeout(formatRequest, 350);
            }
        });
        elements.formatBtn.on('click', formatRequest);

        const clipboard = new ClipboardJS('#copyBtn', {
            text: trigger => $('#sqlOutput').attr('data-clipboard-text') || ''
        });
        clipboard.on('success', function (e) {
            const trigger = $(e.trigger);
            const originalTitle = trigger.attr('data-original-title');
            trigger.attr('data-original-title', 'Copied!').tooltip('show');
            setTimeout(() => trigger.tooltip('hide').attr('data-original-title', originalTitle), 2000);
            e.clearSelection();
        });

        elements.clearBtn.on('click', function () {
            elements.editor.setValue('');
            elements.output.html(outputPlaceholder).removeAttr('data-clipboard-text');
            elements.editor.focus();
        });
        elements.undoBtn.on('click', () => elements.editor.undo());
        elements.redoBtn.on('click', () => elements.editor.redo());

        // --- Final Corrected Tooltip & Dropdown Handling ---
        // 1. Tooltips on the main bar. 'body' is a safe container.
        $('.control-panel > [data-toggle="tooltip"]').tooltip({
            container: 'body',
            delay: {"show": 300, "hide": 100}
        });
        const dropdownMenu = $('.dropdown-menu');
        // 2. Tooltips inside the dropdown. Use a local container for correct positioning.
        dropdownMenu.tooltip({
            selector: '[data-toggle="tooltip"]', // Use delegation within the dropdown
            container: '.dropdown',
            placement: 'left',
            delay: {"show": 300, "hide": 100}
        });
        // 3. Critical fix: Stop clicks inside the dropdown from closing it.
        dropdownMenu.on('click', (e) => e.stopPropagation());

        // --- Theme Toggling ---
        const themeIcon = {light: 'fa-moon-o', dark: 'fa-sun-o'};

        function applyTheme(theme) {
            $('body').attr('data-theme', theme);
            elements.themeToggleBtn.find('.fa').removeClass().addClass(`fa ${themeIcon[theme]}`);
            elements.editor.setOption('theme', editorThemes[theme]);
            localStorage.setItem('sqlFormatterTheme', theme);
        }

        elements.themeToggleBtn.on('click', function () {
            const newTheme = $('body').attr('data-theme') === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
        });
        applyTheme(initialTheme);

        // --- Initial State ---
        elements.output.html(outputPlaceholder);
    });
</script>
</body>
</html>